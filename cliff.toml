[changelog]
trim = true

header = """
# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.1.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).
"""

body = """
{#- Helper: generate GitHub repo URL #}
{%- macro remote_url() -%}
    https://github.com/{{ remote.github.owner }}/{{ remote.github.repo }}
{%- endmacro %}

{#- Helper: print single commit #}
{%- macro print_commit(commit) -%}
    - {% if commit.scope %}`{{ commit.scope }}`: {% endif %}
      {%- if commit.breaking %}[**breaking**] {% endif %}
      {{- commit.message | upper_first }} ([{{ commit.id | truncate(length=7, end="") }}])
{%- endmacro %}

{#- Store the list of commits that will be rendered in a variable #}
{%- set rendered_commits = commits
    | filter(attribute="merge_commit", value=false)
    | unique(attribute="message")
%}

{#- Collect all links from all commits into a single list #}
{%- set issue_links = [] %}
{%- for commit in rendered_commits %}
    {%- if commit.links %}
        {%- set_global issue_links = issue_links | concat(with=commit.links) %}
    {%- endif %}
{%- endfor %}

{#- Now that we have a flat list, remove duplicates and sort it #}
{%- set issue_links = issue_links
    | unique(attribute="href")
    | sort(attribute="text")
%}

{#- Print out the version #}
{%- if version %}
    ## [{{ version | split(pat="-") | last | trim_start_matches(pat="v") }}] - {{ timestamp | date(format="%Y-%m-%d") }}
{% else %}
    ## [Unreleased]
{% endif %}

{#- Loop through commits by group and print them #}
{%- for group, commits in rendered_commits | group_by(attribute="group") %}
    ### {{ group | striptags | trim | upper_first }}
    {% for commit in commits
        | filter(attribute="scope")
        | sort(attribute="scope")
    %}
        {{ self::print_commit(commit=commit) }}
    {%- endfor %}

    {%- raw %}\n{% endraw %}

    {%- for commit in commits %}
        {%- if not commit.scope %}
            {{ self::print_commit(commit=commit) }}
        {%- endif %}
    {%- endfor %}
{%- endfor %}

{#- Add a blank line for spacing before the link definitions #}
{%- raw %}\n{% endraw %}

{#- Create the issue link reference table #}
{%- if issue_links %}
    {%- for link in issue_links %}
        [{{ link.text }}]: {{ link.href }}
    {%- endfor %}
{%- endif %}

{%- raw %}\n{% endraw %}

{#- Create the commit link reference table #}
{%- for commit in rendered_commits %}
    [{{ commit.id | truncate(length=7, end="") }}]: {{ self::remote_url() }}/commit/{{ commit.id }}
{%- endfor %}

{%- raw %}\n{% endraw -%}
"""

[git]
protect_breaking_commits = true

commit_preprocessors = [
    # Replace #123 with [#123] in the commit message
    { pattern = '#(\d+)', replace = '[#$1]' },
]

link_parsers = [
    # Extract #123 and turn it into a GitHub issue link object
    { pattern = '#(\d+)', text = '#$1', href = 'https://github.com/no-simpler/totally-legit/issues/$1' },
]

commit_parsers = [
    { message = "^feat", group = "<!-- 0 -->Features â›°ï¸" },
    { message = "^fix", group = "<!-- 1 -->Bug Fixes ğŸ›" },

    { message = "^refactor\\(clippy\\)", skip = true },
    { message = "^refactor", group = "<!-- 2 -->Refactor ğŸšœ" },
    { message = "^doc", group = "<!-- 3 -->Documentation ğŸ“š" },
    { message = "^perf", group = "<!-- 4 -->Performance âš¡" },
    { message = "^style", group = "<!-- 5 -->Styling ğŸ¨" },
    { message = "^test", group = "<!-- 6 -->Testing ğŸ§ª" },

    { message = "^chore\\(release\\)", skip = true },
    { message = "^chore\\(deps.*\\)", skip = true },
    { message = "^chore\\(pr\\)", skip = true },

    { message = "^chore|^ci", group = "<!-- 7 -->Miscellaneous Tasks âš™ï¸" },
    { message = "^security", group = "<!-- 8 -->Security ğŸ›¡ï¸" },
    { message = "^revert", group = "<!-- 9 -->Revert â—€ï¸" },

    { message = ".*", group = "<!-- 10 -->Other ğŸ’¼" },
]

[remote.github]
owner = "no-simpler"
repo = "totally-legit"
